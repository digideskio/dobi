#
# dobi.yaml example - Initialize a database
# See README.md for a full description of this example.
#

meta:
    project: examplerailsdb


mount=source:
    bind: .
    path: /code


image=rails:
    image: example/web
    dockerfile: Dockerfile
    context: .
    tags: ['{unique}', '{project}']

image=database-img:
    image: example/database
    dockerfile: Dockerfile
    context: db/
    depends: [export-models]
    tags: ['{unique}', '{project}']


compose=empty-db-env:
    files: [empty-db.yaml]
    project: '{project}export'

compose=dev-environment:
    files: [docker-compose.yml]
    project: '{project}'
    depends: ['rails:tag', 'database-img:tag']


run=export-models:
    use: rails
    mounts: [source]
    artifact: export.sql
    command: /code/export.sh
    # Connect the container to the `empty-db-env` network created by Compose
    net-mode: '{project}export_default'
    depends: [empty-db-env]


alias=dev:
    tasks: ['dev-environment:attach']
